<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Check-in Seminario</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}
.card {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  max-width: 420px;
  margin: auto;
  box-shadow: 0 2px 10px rgba(0,0,0,.2);
}
.ok { color: green; }
.error { color: red; }
button {
  padding: 10px 15px;
  border: none;
  border-radius: 6px;
  background: #2d89ef;
  color: white;
  cursor: pointer;
}
pre {
  background: #f7f7f7;
  padding: 10px;
  border-radius: 6px;
  white-space: pre-wrap;
}
</style>
</head>
<body>

<div class="card" id="app">
  <h2>Validando acceso...</h2>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbykY_r3vFP-ZYJqLmxf52PPFQ0qo3N2gZte_hu-CCfI6vUdElDABUwkHam5QNhmlQVoBA/exec";
const params = new URLSearchParams(window.location.search);
const code = params.get("code");

if (!code) {
  document.getElementById("app").innerHTML =
    "<p class='error'>QR inválido</p>";
} else {

fetch(`${API_URL}?api=1&code=${code}`)
  .then(r => r.json())
  .then(res => {
    if (!res.ok) {
      document.getElementById("app").innerHTML =
        `<p class='error'>${res.mensaje}</p>`;
      return;
    }

    const d = res.data;

    const texto = `
ACCESO AUTORIZADO

Nombre: ${d.nombre}
Pastor: ${d.pastor}
WhatsApp: ${d.whatsapp || "-"}
Tipo de pago: ${d.tipoPago}
Usos restantes hoy: ${d.usosRestantes}

Integrantes:
${d.integrantes || "No aplica"}
`.trim();

    document.getElementById("app").innerHTML = `
      <h2 class="ok">${res.mensaje}</h2>
      <pre id="txt">${texto}</pre>
      <button onclick="descargar()">Descargar comprobante</button>
    `;

    window.descargar = () => {
      const blob = new Blob([texto], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "comprobante_acceso.txt";
      a.click();
      URL.revokeObjectURL(url);
    };
  })
  .catch(() => {
    document.getElementById("app").innerHTML =
      "<p class='error'>Error de conexión</p>";
  });
}
</script>

</body>
</html>
